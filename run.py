"""
Скрипт для запуска всего проекта с полной базой данных
"""
import os
import sys
import subprocess
import sqlite3
from datetime import datetime, timedelta
import hashlib
import traceback

def setup_project():
    print("="*60)
    print("НАСТРОЙКА ПРОЕКТА ВЕТЕРИНАРНОЙ КЛИНИКИ 'ДРУГ'")
    print("="*60)
    
    # 1. Установка зависимостей
    print("\n1. Установка зависимостей...")
    try:
        requirements = [
            "Flask==2.3.2",
            "Werkzeug==2.3.7", 
            "Flask-SQLAlchemy==3.0.5",
            "Flask-Login==0.6.2",
            "Flask-WTF==1.1.1",
            "python-dotenv==1.0.0",
            "email-validator==2.0.0"
        ]
        
        for package in requirements:
            print(f"  Устанавливаю {package}...")
            try:
                subprocess.check_call([sys.executable, "-m", "pip", "install", package])
            except subprocess.CalledProcessError as e:
                print(f"    Предупреждение: не удалось установить {package}: {e}")
        print("✓ Зависимости установлены")
    except Exception as e:
        print(f"✗ Ошибка установки зависимостей: {e}")
        return False
    
    # 2. Создание структуры папок
    print("\n2. Создание структуры папок...")
    folders = [
        "static/images/banners",
        "static/images/doctors", 
        "static/images/articles",
        "static/images/news",
        "static/images/testimonials",
        "static/images/services",
        "static/images/misc",
        "static/css",
        "static/js",
        "templates/auth",
        "instance"
    ]
    
    for folder in folders:
        if not os.path.exists(folder):
            os.makedirs(folder)
            print(f"  Создана папка: {folder}")
        else:
            print(f"  Папка уже существует: {folder}")
    
    print("✓ Структура папок создана")
    
    # 3. Создание файла .env
    print("\n3. Создание файла конфигурации...")
    env_content = '''SECRET_KEY=your-secret-key-change-in-production-1234567890
DATABASE_URL=sqlite:///vetclinic.db
DEBUG=True
'''
    
    try:
        with open('.env', 'w', encoding='utf-8') as f:
            f.write(env_content)
        print("✓ Файл .env создан")
    except Exception as e:
        print(f"✗ Ошибка создания .env: {e}")
    
    # 4. Создание базы данных с полными данными
    print("\n4. Создание базы данных...")
    try:
        # Используем прямое создание через SQLite для надежности
        success = create_database_directly()
        if success:
            print("✓ База данных успешно создана")
        else:
            print("✗ База данных уже существует или произошла ошибка")
    except Exception as e:
        print(f"✗ Ошибка создания базы данных: {e}")
        print("Подробности ошибки:")
        traceback.print_exc()
        return False
    
    print("\n" + "="*60)
    print("ПРОЕКТ УСПЕШНО НАСТРОЕН!")
    print("="*60)
    
    print("\n" + "="*60)
    print("СОЗДАННЫЕ ТЕСТОВЫЕ ДАННЫЕ:")
    print("="*60)
    print("\nПОЛЬЗОВАТЕЛИ:")
    print("1. Администратор:")
    print("   Email: admin@vetclinic.ru")
    print("   Пароль: admin123")
    print("   Роль: Администратор (полный доступ)")
    
    print("\n2. Сотрудник (врач):")
    print("   Email: doctor@vetclinic.ru")
    print("   Пароль: doctor123")
    print("   Роль: Сотрудник (доступ к расписанию и пациентам)")
    
    print("\n3. Клиент:")
    print("   Email: client@example.ru")
    print("   Пароль: client123")
    print("   Роль: Клиент (запись на прием, история посещений)")
    
    print("\nУСЛУГИ (8 услуг):")
    services_list = [
        "• Первичный прием терапевта (1500 руб.)",
        "• Вакцинация от бешенства (1200 руб.)",
        "• Стерилизация кошки (7000 руб.)",
        "• УЗИ брюшной полости (2500 руб.)",
        "• Чистка зубов (3500 руб.)",
        "• Экстренная помощь (3000 руб.)",
        "• Груминг собаки (2000 руб.)",
        "• Анализ крови (1800 руб.)"
    ]
    for service in services_list:
        print(f"   {service}")
    
    print("\nВРАЧИ (5 специалистов):")
    doctors_list = [
        "• Иванова Анна Сергеевна - Терапевт, гастроэнтеролог (10 лет опыта)",
        "• Петров Игорь Владимирович - Хирург, травматолог (15 лет опыта)",
        "• Смирнова Ольга Александровна - Дерматолог, аллерголог (8 лет опыта)",
        "• Кузнецов Алексей Николаевич - Стоматолог (12 лет опыта)",
        "• Волкова Мария Дмитриевна - Кардиолог, УЗИ-диагност (9 лет опыта)"
    ]
    for doctor in doctors_list:
        print(f"   {doctor}")
    
    print("\nСТАТЬИ (5 статей):")
    articles_list = [
        "• Как правильно ухаживать за зубами собаки (156 просмотров)",
        "• Вакцинация щенков: полный график прививок (234 просмотра)",
        "• Питание кошек: сухой или влажный корм? (189 просмотров)",
        "• Первые признаки болезни у питомца (312 просмотров)",
        "• Подготовка питомца к операции (145 просмотров)"
    ]
    for article in articles_list:
        print(f"   {article}")
    
    print("\nНОВОСТИ (5 новостей):")
    news_list = [
        "• Открытие нового отделения реабилитации (вчера)",
        "• Акция на стерилизацию кошек (3 дня назад)",
        "• Новое оборудование в лаборатории (5 дней назад)",
        "• Бесплатные консультации для владельцев пожилых животных (7 дней назад)",
        "• Наша клиника получила международную сертификацию (10 дней назад)"
    ]
    for news_item in news_list:
        print(f"   {news_item}")
    
    print("\nЗАПИСИ НА ПРИЕМ (3 записи):")
    appointments_list = [
        "• Кошка Барсик (3 года) - плановый осмотр - ЗАВТРА 10:00",
        "• Собака Шарик (5 лет) - анализ крови - ПОСЛЕЗАВТРА 14:00",
        "• Кошка Барсик (3 года) - чистка зубов - ВЫПОЛНЕНО"
    ]
    for appointment in appointments_list:
        print(f"   {appointment}")
    
    print("\n" + "="*60)
    print("\nЗАПУСК ПРИЛОЖЕНИЯ:")
    print("="*60)
    print("\nСпособ 1: Запустить приложение (откроется в браузере)")
    print("  python app.py")
    
    print("\nСпособ 2: Запустить через Flask")
    print("  flask run")
    
    print("\nСпособ 3: Запустить с отладкой")
    print("  flask run --debug")
    
    print("\nПосле запуска откройте в браузере:")
    print("  http://localhost:5000")
    
    print("\nСайт будет работать локально на вашем компьютере.")
    
    return True

def create_database_directly():
    """Создание базы данных напрямую через SQLite с проверкой существующих данных"""
    
    # Создаем папку instance, если её нет
    if not os.path.exists('instance'):
        os.makedirs('instance')
    
    db_path = 'instance/vetclinic.db'
    
    # Проверяем, существует ли уже база данных
    if os.path.exists(db_path):
        print("  База данных уже существует. Проверяем содержимое...")
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        
        # Проверяем существующие пользователи
        try:
            cursor.execute("SELECT COUNT(*) FROM users WHERE email IN (?, ?, ?)", 
                          ('admin@vetclinic.ru', 'doctor@vetclinic.ru', 'client@example.ru'))
            count = cursor.fetchone()[0]
            
            if count > 0:
                print(f"  Найдено {count} существующих пользователей.")
                print("  Пропускаем создание тестовых данных.")
                conn.close()
                return True
        except sqlite3.OperationalError:
            # Таблица users не существует
            print("  Таблица users не существует. Создаем новую базу.")
            conn.close()
            os.remove(db_path)  # Удаляем старую базу
        
        conn.close()
    
    # Создаем новую базу данных
    print("  Создаем новую базу данных...")
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    # Функция для хеширования паролей
    def hash_password(password):
        return hashlib.sha256(password.encode()).hexdigest()
    
    # Создаем таблицы
    
    # 1. Таблица пользователей
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        email TEXT UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        role TEXT NOT NULL DEFAULT 'client',
        full_name TEXT,
        phone TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    )
    ''')
    
    # 2. Таблица услуг
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS service (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        description TEXT,
        price REAL,
        category TEXT,
        duration TEXT
    )
    ''')
    
    # 3. Таблица врачей
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS doctor (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        specialization TEXT,
        experience INTEGER,
        education TEXT,
        bio TEXT,
        photo_url TEXT,
        schedule TEXT
    )
    ''')
    
    # 4. Таблица статей
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS article (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        content TEXT NOT NULL,
        category TEXT,
        author_id INTEGER,
        image_url TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        is_published BOOLEAN DEFAULT 1,
        views INTEGER DEFAULT 0,
        FOREIGN KEY (author_id) REFERENCES users (id)
    )
    ''')
    
    # 5. Таблица новостей
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS news (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        content TEXT NOT NULL,
        author_id INTEGER,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        is_published BOOLEAN DEFAULT 1,
        FOREIGN KEY (author_id) REFERENCES users (id)
    )
    ''')
    
    # 6. Таблица записей на прием
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS appointment (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        client_id INTEGER,
        doctor_id INTEGER,
        service_id INTEGER,
        pet_name TEXT,
        pet_species TEXT,
        pet_age INTEGER,
        date_time TIMESTAMP NOT NULL,
        status TEXT DEFAULT 'pending',
        notes TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (client_id) REFERENCES users (id),
        FOREIGN KEY (doctor_id) REFERENCES doctor (id),
        FOREIGN KEY (service_id) REFERENCES service (id)
    )
    ''')
    
    # Добавляем тестовые данные с использованием INSERT OR REPLACE
    try:
        # 1. Пользователи
        users = [
            ('admin', 'admin@vetclinic.ru', hash_password('admin123'), 'admin', 
             'Администратор Системы', '+7 (495) 000-00-01'),
            ('vet_doctor', 'doctor@vetclinic.ru', hash_password('doctor123'), 'staff',
             'Иванова Анна Сергеевна', '+7 (495) 123-45-67'),
            ('pet_lover', 'client@example.ru', hash_password('client123'), 'client',
             'Петров Иван Иванович', '+7 (916) 123-45-67')
        ]
        
        for user in users:
            cursor.execute('''
                INSERT OR REPLACE INTO users (username, email, password_hash, role, full_name, phone) 
                VALUES (?, ?, ?, ?, ?, ?)
            ''', user)
        
        print("  ✓ Пользователи созданы")
        
        # Получаем ID созданных пользователей
        cursor.execute("SELECT id, username FROM users")
        user_data = cursor.fetchall()
        user_ids = {}
        for user_id, username in user_data:
            if username == 'vet_doctor':
                user_ids['vet_doctor'] = user_id
            elif username == 'pet_lover':
                user_ids['pet_lover'] = user_id
        
        # 2. Услуги
        services = [
            ('Первичный прием терапевта', 
             'Комплексный осмотр животного, консультация, постановка предварительного диагноза', 
             1500.0, 'Терапия', '30-40 мин'),
            ('Вакцинация от бешенства', 
             'Вакцинация от бешенства с оформлением ветеринарного паспорта', 
             1200.0, 'Вакцинация', '20 мин'),
            ('Стерилизация кошки', 
             'Хирургическая операция по стерилизации кошки, включая наркоз и послеоперационный уход', 
             7000.0, 'Хирургия', '1.5 часа'),
            ('УЗИ брюшной полости', 
             'Ультразвуковое исследование органов брюшной полости', 
             2500.0, 'Диагностика', '40 мин'),
            ('Чистка зубов', 
             'Профессиональная чистка зубов ультразвуком под наркозом', 
             3500.0, 'Стоматология', '1 час'),
            ('Экстренная помощь', 
             'Срочный прием при травмах, острых состояниях, отравлениях', 
             3000.0, 'Экстренная помощь', 'По необходимости'),
            ('Груминг собаки', 
             'Комплексный уход: стрижка, мытье, сушка, стрижка когтей', 
             2000.0, 'Груминг', '2 часа'),
            ('Анализ крови', 
             'Общий и биохимический анализ крови', 
             1800.0, 'Лаборатория', '15 мин')
        ]
        
        cursor.executemany(
            "INSERT OR REPLACE INTO service (name, description, price, category, duration) VALUES (?, ?, ?, ?, ?)",
            services
        )
        print("  ✓ Услуги созданы")
        
        # 3. Врачи
        doctors = [
            ('Иванова Анна Сергеевна', 'Терапевт, гастроэнтеролог', 10,
             'Московская государственная академия ветеринарной медицины, 2012',
             'Специалист по внутренним болезням мелких домашних животных. Владеет УЗИ-диагностикой.',
             'doctors/doctor1.jpg', 'Пн-Пт 9:00-18:00'),
            ('Петров Игорь Владимирович', 'Хирург, травматолог', 15,
             'Санкт-Петербургская государственная академия ветеринарной медицины, 2007',
             'Выполняет сложные ортопедические и абдоминальные операции. Специалист по эндопротезированию.',
             'doctors/doctor2.jpg', 'Вт-Сб 10:00-19:00'),
            ('Смирнова Ольга Александровна', 'Дерматолог, аллерголог', 8,
             'Казанская государственная академия ветеринарной медицины, 2014',
             'Специалист по кожным заболеваниям и аллергиям у животных. Владеет методами цитологии и трихологии.',
             'doctors/doctor3.jpg', 'Пн-Ср-Пт 8:00-17:00'),
            ('Кузнецов Алексей Николаевич', 'Стоматолог, челюстно-лицевой хирург', 12,
             'Новосибирский государственный аграрный университет, 2010',
             'Специалист по заболеваниям ротовой полости. Выполняет сложные стоматологические операции.',
             'doctors/doctor4.jpg', 'Вт-Чт-Сб 9:00-18:00'),
            ('Волкова Мария Дмитриевна', 'Кардиолог, УЗИ-диагност', 9,
             'Российский университет дружбы народов, 2013',
             'Специалист по заболеваниям сердечно-сосудистой системы. Владеет ЭхоКГ и ЭКГ диагностикой.',
             'doctors/doctor5.jpg', 'Пн-Пт 10:00-19:00')
        ]
        
        cursor.executemany(
            "INSERT OR REPLACE INTO doctor (name, specialization, experience, education, bio, photo_url, schedule) VALUES (?, ?, ?, ?, ?, ?, ?)",
            doctors
        )
        print("  ✓ Врачи созданы")
        
        # 4. Статьи - ИСПРАВЛЕННЫЕ ДАННЫЕ С ПОЛНЫМ СОДЕРЖАНИЕМ
        articles = [
            ('Как правильно ухаживать за зубами собаки',
             '''Регулярный уход за зубами собаки — залог ее здоровья и долголетия. Вот основные рекомендации:

1. **Ежедневная чистка зубов**: Используйте специальную зубную щетку и пасту для собак. Никогда не используйте человеческую зубную пасту!

2. **Зубные лакомства**: Специальные лакомства помогают уменьшить образование зубного камня.

3. **Регулярные осмотры**: Посещайте ветеринарного стоматолога минимум раз в год.

4. **Профессиональная чистка**: Рекомендуется проводить 1-2 раза в год под наркозом.

**Признаки проблем с зубами:**
- Неприятный запах изо рта
- Кровоточивость десен
- Отказ от твердой пищи
- Изменение цвета зубов
- Опухание морды

Профилактика всегда лучше лечения! Начинайте уход за зубами с раннего возраста щенка.''',
             'Уход', user_ids.get('vet_doctor', 2), 'images/articles/dental_care.jpg', 156),
            ('Вакцинация щенков: полный график прививок',
             '''Вакцинация — важнейшая часть заботы о здоровье щенка. Правильный график защитит вашего питомца от опасных заболеваний.

**График вакцинации:**

1. **6-8 недель**: Первая комплексная вакцина (чума, парвовироз, гепатит)
2. **10-12 недель**: Ревакцинация + прививка от бешенства
3. **14-16 недель**: Последняя вакцинация щенячьего возраста
4. **Ежегодно**: Ревакцинация всех прививок

**Важные правила:**
- За 10 дней до вакцинации проведите дегельминтизацию
- Соблюдайте карантин 2 недели после прививки
- Всегда ведите ветеринарный паспорт
- Не гуляйте с непривитым щенком в общественных местах

**Возможные реакции на прививку:**
- Небольшая вялость в течение 24 часов
- Незначительное повышение температуры
- Уплотнение в месте укола (проходит за 2-3 дня)

Если у щенка наблюдается рвота, сильная аллергическая реакция или судороги — немедленно обратитесь к ветеринару!''',
             'Вакцинация', user_ids.get('vet_doctor', 2), 'images/articles/vaccination.jpg', 234),
            ('Питание кошек: сухой или влажный корм?',
             '''Выбор между сухим и влажным кормом зависит от многих факторов:

**Сухой корм:**
+ Удобство хранения и использования
+ Способствует очищению зубов
+ Экономичность
- Требует достаточного потребления воды
- Не подходит для кошек с проблемами почек

**Влажный корм:**
+ Высокое содержание влаги
+ Легче усваивается
+ Более привлекательный вкус
- Быстро портится после вскрытия
- Может способствовать образованию зубного камня

**Рекомендации:**
1. Комбинированное питание: утром влажный корм, вечером сухой
2. Всегда свежая вода в свободном доступе
3. Кормление по возрасту и состоянию здоровья
4. Консультация с ветеринаром при выборе корма

**Примерный суточный рацион для взрослой кошки:**
- Сухой корм: 40-60 г на 1 кг веса
- Влажный корм: 200-300 г на 1 кг веса

Помните: качество корма важнее его формы!''',
             'Питание', user_ids.get('vet_doctor', 2), 'images/articles/cat_food.jpg', 189),
            ('Первые признаки болезни у питомца',
             '''Своевременное обнаружение симптомов болезни может спасти жизнь вашему питомцу. Тревожные признаки:

**Общие симптомы:**
- Вялость, апатия
- Отказ от еды более 24 часов
- Повышенная жажда
- Изменение веса
- Снижение активности

**Специфические симптомы:**
- Рвота или диарея
- Затрудненное дыхание
- Хромота
- Изменение поведения
- Выпадение шерсти
- Выделения из глаз, носа, ушей
- Кашель или чихание
- Частое мочеиспускание

**Что делать при обнаружении симптомов:**
1. Измерьте температуру (норма: 37.5-39°C)
2. Обеспечьте покой
3. Не давайте лекарства без назначения врача
4. Немедленно обратитесь в клинику

**Экстренные ситуации (требуют немедленной помощи):**
- Травма с кровотечением
- Затрудненное дыхание
- Судороги
- Отравление
- Переломы

Профилактика: регулярные осмотры у ветеринара 1-2 раза в год.''',
             'Здоровье', user_ids.get('vet_doctor', 2), 'images/articles/symptoms.jpg', 312),
            ('Подготовка питомца к операции',
             '''Правильная подготовка к операции снижает риски и ускоряет восстановление:

**За 2 недели до операции:**
- Полный медицинский осмотр
- Анализы крови и мочи
- Консультация анестезиолога
- Обсуждение всех рисков и процедуры

**За 24 часа до операции:**
- Легкая диета
- Ограничение физических нагрузок
- Последний прием пищи за 12 часов до операции
- Последнее питье за 6 часов до операции
- Вечерняя прогулка для собак

**В день операции:**
- Прибыть в клинику заранее
- Принести любимую подстилку или игрушку
- Сообщить врачу обо всех особенностях питомца
- Уточнить время посещения

**Послеоперационный уход:**
- Соблюдение рекомендаций врача
- Обработка швов 2 раза в день
- Ограничение активности на 10-14 дней
- Специальная диета
- Регулярные осмотры у врача
- Ношение защитного воротника

**Тревожные признаки после операции:**
- Кровотечение из шва
- Отек или покраснение
- Отказ от еды более суток
- Повышение температуры
- Вялость и апатия

Помните: современная ветеринарная анестезия безопасна при правильной подготовке.''',
             'Хирургия', user_ids.get('vet_doctor', 2), 'images/articles/surgery_prep.jpg', 145)
        ]
        
        cursor.executemany(
            "INSERT OR REPLACE INTO article (title, content, category, author_id, image_url, views) VALUES (?, ?, ?, ?, ?, ?)",
            articles
        )
        print("  ✓ Статьи созданы (5 статей с полным содержанием)")
        
        # 5. Новости
        news_items = [
            ('Открытие нового отделения реабилитации',
             '''Рады сообщить об открытии нового современного отделения реабилитации животных в нашей клинике!

**Что включает новое отделение:**
- Гидротерапия (бассейн с беговой дорожкой)
- Физиотерапевтическое оборудование
- Массажный кабинет
- Зал для лечебной физкультуры

**Для кого предназначено:**
- Животные после операций
- Питомцы с возрастными изменениями
- Спортивные и рабочие собаки
- Животные с неврологическими проблемами

Отделение работает ежедневно с 9:00 до 21:00. Запись по телефону: +7 (495) 123-45-67''',
             user_ids.get('vet_doctor', 2)),
            ('Акция на стерилизацию кошек',
             '''С 1 по 30 апреля действует специальная цена на стерилизацию кошек!

**Акционные цены:**
- Стерилизация кошки: 5000 руб. (вместо 7000 руб.)
- Кастрация кота: 4000 руб. (вместо 5500 руб.)

**Что входит в стоимость:**
- Операция
- Наркоз
- Послеоперационный уход
- Препараты для обезболивания
- Консультация по уходу

**Условия акции:**
1. Запись по предварительной записи
2. Действует для всех пород
3. Обязательна предварительная консультация

Не упустите возможность позаботиться о здоровье вашего питомца по выгодной цене!''',
             user_ids.get('vet_doctor', 2)),
            ('Новое оборудование в лаборатории',
             '''Наша клиника приобрела новейшее диагностическое оборудование!

**Новое оборудование:**
1. **Автоматический биохимический анализатор** - позволяет получить результаты анализов за 15 минут
2. **Цифровой рентген** - высокое качество снимков при минимальной лучевой нагрузке
3. **УЗИ-аппарат экспертного класса** - точная диагностика внутренних органов
4. **Эндоскопическая система** - малоинвазивная диагностика и операции

**Преимущества нового оборудования:**
- Более точная диагностика
- Быстрые результаты
- Минимальный стресс для животных
- Возможность ранней диагностики заболеваний

Теперь мы можем предложить нашим пациентам диагностику на уровне ведущих ветеринарных клиник Европы!''',
             user_ids.get('vet_doctor', 2)),
            ('Бесплатные консультации для владельцев пожилых животных',
             '''Каждую субботу с 10:00 до 14:00 проводим бесплатные консультации для владельцев животных старше 7 лет.

**Что включает консультация:**
- Общий осмотр питомца
- Измерение давления
- Анализ состояния зубов
- Рекомендации по уходу
- Консультация по питанию

**Специальные программы для пожилых животных:**
1. **Ежегодный чекап** - комплексное обследование 2 раза в год
2. **Программа долголетия** - индивидуальный план ухода
3. **Паллиативная помощь** - поддержка при хронических заболеваниях

**Запись обязательна!** Количество мест ограничено. Телефон для записи: +7 (495) 123-45-67''',
             user_ids.get('vet_doctor', 2)),
            ('Наша клиника получила международную сертификацию',
             '''С гордостью сообщаем, что наша клиника получила международную сертификацию ISO 9001:2015!

**Что это значит для наших пациентов:**
- Гарантия качества всех услуг
- Стандартизированные протоколы лечения
- Постоянное повышение квалификации персонала
- Современные методы диагностики и лечения
- Европейские стандарты обслуживания

**Наши достижения:**
- Более 5000 успешных операций
- 95% положительных отзывов
- 15 врачей высшей категории
- Круглосуточная экстренная помощь

Мы продолжаем развиваться и улучшать качество наших услуг для здоровья ваших питомцев!''',
             user_ids.get('vet_doctor', 2))
        ]
        
        cursor.executemany(
            "INSERT OR REPLACE INTO news (title, content, author_id) VALUES (?, ?, ?)",
            news_items
        )
        print("  ✓ Новости созданы")
        
        # 6. Записи на прием
        appointments = [
            (user_ids.get('pet_lover', 3), 1, 1, 'Барсик', 'Кошка', 3, 
             (datetime.now() + timedelta(days=1, hours=10)).strftime('%Y-%m-%d %H:%M:%S'),
             'confirmed', 'Плановый осмотр, жалоб нет'),
            (user_ids.get('pet_lover', 3), 2, 4, 'Шарик', 'Собака', 5,
             (datetime.now() + timedelta(days=2, hours=14)).strftime('%Y-%m-%d %H:%M:%S'),
             'pending', 'Анализ крови, контроль после лечения'),
            (user_ids.get('pet_lover', 3), 1, 5, 'Барсик', 'Кошка', 3,
             (datetime.now() - timedelta(days=5)).strftime('%Y-%m-%d %H:%M:%S'),
             'completed', 'Чистка зубов, все прошло успешно')
        ]
        
        cursor.executemany(
            "INSERT OR REPLACE INTO appointment (client_id, doctor_id, service_id, pet_name, pet_species, pet_age, date_time, status, notes) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)",
            appointments
        )
        print("  ✓ Записи на прием созданы")
        
        # Сохраняем изменения
        conn.commit()
        
        # Проверяем созданные данные
        print("\n  Проверка созданных данных:")
        cursor.execute("SELECT COUNT(*) FROM article")
        article_count = cursor.fetchone()[0]
        print(f"    Статей в базе: {article_count}")
        
        cursor.execute("SELECT title, category, LENGTH(content) as content_length FROM article")
        articles_data = cursor.fetchall()
        for article in articles_data:
            print(f"    '{article[0]}' - категория: {article[1]}, длина контента: {article[2]} символов")
        
        # Закрываем соединение
        conn.close()
        
        print("\n  ✓ Все данные успешно созданы и проверены")
        return True
        
    except sqlite3.IntegrityError as e:
        print(f"  ✗ Ошибка целостности данных: {e}")
        print("  Пытаемся очистить таблицы и создать заново...")
        
        # Закрываем текущее соединение
        conn.close()
        
        # Удаляем базу данных и создаем заново
        if os.path.exists(db_path):
            os.remove(db_path)
        
        # Рекурсивно вызываем функцию снова
        return create_database_directly()
        
    except Exception as e:
        print(f"  ✗ Неизвестная ошибка: {e}")
        traceback.print_exc()
        conn.close()
        return False

if __name__ == '__main__':
    print("Запуск установки проекта...")
    
    try:
        success = setup_project()
        if success:
            print("\nГотово! Проект успешно настроен.")
            """
            # Спрашиваем, запускать ли приложение
            choice = input("\nЗапустить приложение сейчас? (да/нет): ").lower().strip()
            if choice in ['да', 'д', 'y', 'yes', '1']:
                print("\nЗапускаю приложение...")
                try:
                    # Импортируем и запускаем app.py
                    import app
                    app.app.run(debug=True, host='0.0.0.0', port=5000)
                except ImportError:
                    print("Файл app.py не найден. Убедитесь, что он находится в текущей папке.")
                    print("Создайте app.py или используйте команду: flask run")
            """
        else:
            print("\nОшибка! Проект не был настроен.")
    except KeyboardInterrupt:
        print("\n\nУстановка прервана пользователем.")
    except Exception as e:
        print(f"\nКритическая ошибка: {e}")
        print("Пожалуйста, проверьте настройки системы и повторите попытку.")
    
    input("\nНажмите Enter для выхода...")
    